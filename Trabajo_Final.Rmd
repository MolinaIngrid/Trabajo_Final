---
title: "Proyecto final"
author: "Ingrid MM"
date: "30/11/2020"
output: 
  prettydoc::html_pretty:
    theme: hpstr
    highlight: vignette
vignette: >
  %\VignetteIndexEntry{Creating Pretty Documents from R Markdown - The HPSTR Theme}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### 1. ¿Cuál es la pregunta específica de investigación?

Identificar umbrales donde cambia la probabilidad de ocupación de especies de aves prioritarias  para la conservación, en relación con la complejidad estructural vegetal del paisaje.

Los datos para estimar la complejidad vegetal no los tendremos sino hasta enero 2021 por lo que para este ejercicio utilizaré información de biomasa vegetal. 

### 2. ¿Cuáles son las variables relevantes y cuál es su relación, conocida y/o hipotética? Para esta pregunta debe presentar al menos un DAG, a menos que la pregunta sea 100% descriptiva y no causal. 

La variable respuesta es la probabilidad de ocupación de las distintas especies de aves (ψ). 
La variable predictora es en este caso la Biomasa Vegetal sobre el suelo (BVSS) en radios de 30 y 100 m.


### 3. ¿De dónde vienen los datos? Si son datos empíricos debe incluir el código para su procesamiento desde datos crudos, hasta datos analizables. 

Los datos vienen del trabajo de campo hecho desde finales de 2019 al 2020. Utilicé puntos de conteo de radio fijo y la aplicación ebird para anotar todas las especies detectadas en cada uno de los 160 puntos. Al bajar de la aplicación toda la información obtengo unas tablas muy grandes por eso debo procesar los datos

## Procesamiento de los datos:

A continueción todas las librerías que necesito pero antes me aseguro de tener los respectivos paquetes:

library(sf)

library(rnaturalearth)

library(lubridate)

library(tidyverse)

library(readr)

library(dplyr)

library(plyr)

library(tidyr)

library(readr)

library(unmarked)

library(MuMIn)

library(AICcmodavg)

```{r, include=FALSE}

library(sf)
library(rnaturalearth)
library(lubridate)
library(tidyverse)
library(readr)
library(dplyr)
library(plyr)
library(tidyr)
library(readr)
library(unmarked)
library(MuMIn)
library(AICcmodavg)

```

Ahora leemos todos los datos que tenemos de los puntos de conteo hechos en Costa Rica

```{r}
CRdatos_all <- read.csv("C:/Users/in/Documents/MAESTRIA/Cursos/Estrategias/Trabajo_Final/MyEBirdData.csv",stringsAsFactors=FALSE)
head(CRdatos_all)
dim(CRdatos_all)
#vemos que hay un total de 19,839 registros
names(CRdatos_all)

```

Revisando notamos que hay algunos errores en los nombres científicos entonces hay que corregirlos:

```{r}

Data.CR.2020.BPI.rsp <- CRdatos_all[!grepl("sp,", CRdatos_all[["Scientific.Name"]]), ]
Data.CR.2020.BPI.rsp <- Data.CR.2020.BPI.rsp[!grepl("sp.", Data.CR.2020.BPI.rsp[["Scientific.Name"]]), ]
Data.CR.2020.BPI.rsp <- Data.CR.2020.BPI.rsp[!grepl("sp ", Data.CR.2020.BPI.rsp[["Scientific.Name"]]), ]


Data.CR.2020.BPI.rsp$Scientific.Name[which(Data.CR.2020.BPI.rsp$Scientific.Name == "Ramphocelus passerinii passerinii")] <- "Ramphocelus costaricensis"
Data.CR.2020.BPI.rsp$Scientific.Name[which(Data.CR.2020.BPI.rsp$Scientific.Name == "Ramphocelus passerinii costaricensis")] <- "Ramphocelus costaricensis"
Data.CR.2020.BPI.rsp$Scientific.Name[which(Data.CR.2020.BPI.rsp$Scientific.Name == "Empidonax alnorum/traillii")] <- "Empidonax traillii"

Lista.especies.all <- unique(Data.CR.2020.BPI.rsp$Scientific.Name)
length(Lista.especies.all)

```

Verificamos que en Costa Rica hemos registrado un total de **218** especies distintas!

Posteriormente hacemos un subset de datos sólo con los puntos de conteo que establecimos mediante coordenadas. 


```{r}
Data.CR.2020.BPI <- Data.CR.2020.BPI.rsp[grepl("BPI-", Data.CR.2020.BPI.rsp[["Location"]]), ]
names(Data.CR.2020.BPI)
dim(Data.CR.2020.BPI)

Datos_fincas <- Data.CR.2020.BPI[,c("Location","Latitude","Longitude")]

# Acá con distinct quito los dublicados 
Datos_BPI_CR <- distinct(Datos_fincas)
dim(Datos_BPI_CR)
head(Datos_fincas)

##acá hacemos un archivo csv para tener ese sub set de datos por separado:

write.csv(Datos_BPI_CR,"Datos_BPI_CR.csv", row.names = FALSE)
Datos_BPI_CR$Location

```


Luego separamos la fecha varias columnas para año, mes y día. Esto porque luego nos es más fácil seleccionar datos de un sólo mes, por ejemplo. La columna rec_1 es simplemente para colocar un 1 en cada observación.
```{r}
Data.CR.2020.BPI <- Data.CR.2020.BPI %>% 
  dplyr::mutate(year = lubridate::year(Date), 
                month = lubridate::month(Date), 
                day = lubridate::day(Date),
                rec_1 = 1)
unique(Data.CR.2020.BPI$year)

dim(Data.CR.2020.BPI)
head(Data.CR.2020.BPI)

```

Confirmo la cantidad de especies que hemos visto entre 2019 y 2020. Además cargo la información sobre la categoria de conservación de Centro América y la categoría a nivel nacional. Uso dos listas porque algunas especies migratorias no están en la lista nacional y algunas especies endémicas no esntán en la centroamericana. **Esas listas ya tienen la taxonomía actualizada**

```{r}
Lista.especies.total <- unique(Data.CR.2020.BPI$Scientific.Name)
length(Lista.especies.total)

CR_bird_info <- read.delim("C:/Users/in/Documents/MAESTRIA/Cursos/Estrategias/Trabajo_Final/Lista_Costa_Rica.txt",stringsAsFactors=FALSE)
PIF_bird_info <- read.csv("C:/Users/in/Documents/MAESTRIA/Cursos/Estrategias/Trabajo_Final/CA_PIF_DataBase.csv",stringsAsFactors=FALSE)
PIF_bird_info.red <- PIF_bird_info[,c(3,5,6)]

```

Posteriormente quiero sustraer sólo las columnas de interés para el análisis que son los nombres científicos, familias y orden.

```{r}

names(CR_bird_info)
names(PIF_bird_info.red) <- c("Sci_name","Oder","Family")

#acá lo que hacemos es juntar la información de la lista "PIF" con la lista que tenemos de los conteos para tener todo en una sóla
CR_bird_info2 <- CR_bird_info %>% left_join(PIF_bird_info.red)

dim(CR_bird_info2)
names(CR_bird_info2)
#Acá sólo queremos tener las 213 especies que corresponden a nuestros conteos 

Aves_CR_sub <- subset(CR_bird_info2, Sci_name %in% Lista.especies.total)
names(Aves_CR_sub)
dim(Aves_CR_sub)

Lista.especies.info <- unique(CR_bird_info$Sci_name)
```

Acontinuación, hay algunas especies en esas listas que usamos a las cuales no se les asignó un orden y/o familia, entonces las rellenamos acá.

```{r}

# missing_info <- setdiff(Lista.especies.total,Lista.especies.info)

#Acá relleno la información sobre los ordenes y familias que no estaban incluidas en las listas rojas.
which(is.na(Aves_CR_sub$Oder))
# 2  26  62 104 122 141 176 184 212
Aves_CR_sub[2,]
Aves_CR_sub$Oder[2] <- "Caprimulgiformes"
Aves_CR_sub$Family[2] <- "Throchilidae"

Aves_CR_sub[26,]
Aves_CR_sub$Oder[26] <- "Caprimulgiformes"
Aves_CR_sub$Family[26] <- "Throchilidae"

Aves_CR_sub[62,]
Aves_CR_sub$Oder[62] <- "Passeriformes"
Aves_CR_sub$Family[62] <- "Cardinalidae"

Aves_CR_sub[104,]
Aves_CR_sub$Oder[104] <- "Passeriformes"
Aves_CR_sub$Family[104] <- "Passerellidae"

Aves_CR_sub[122,]
Aves_CR_sub$Oder[122] <- "Passeriformes"
Aves_CR_sub$Family[122] <- "Parulidae"

Aves_CR_sub[141,]
Aves_CR_sub$Oder[141] <- "Piciformes"
Aves_CR_sub$Family[141] <- "Dryobates"

Aves_CR_sub[176,]
Aves_CR_sub$Oder[176] <- "Passeriformes"
Aves_CR_sub$Family[176] <- "Sporophila"

Aves_CR_sub[184,]
Aves_CR_sub$Oder[184] <- "Passeriformes"
Aves_CR_sub$Family[184] <- "Thraupidae"

Aves_CR_sub[212,]
Aves_CR_sub$Oder[212] <- "Passeriformes"
Aves_CR_sub$Family[212] <- "Tyrannidae"


names(Aves_CR_sub) 

```

Ahora quiero saber cuantas especies de las que tenemos registradas están en las listas de la IUCN 

```{r}
IUCN_counts <- Aves_CR_sub %>%
  group_by(Red_list_16) %>%
  tally

IUCN_VU_CR <- Aves_CR_sub$Sci_name[which(Aves_CR_sub$Red_list_16 == "VU")]
IUCN_NT_CR <- Aves_CR_sub$Sci_name[which(Aves_CR_sub$Red_list_16 == "NT")]


Aves_CR_sub[26,]
```

Y cuantas estan en las listas de especies amenazadas de Costa Rica y Centroamérica 
```{r}

WatchList_counts <- Aves_CR_sub %>%
  group_by(Cont_concern) %>%
  tally

Family_counts <- Aves_CR_sub %>%
  group_by(Family) %>%
  tally

CR_Family_List <- as.data.frame(Family_counts)

CR_Family_List
        
```



4. Análisis de los datos. Se vale escoger un subconjunto de los datos para que esta sección sea concisa, pero debe ser un análisis coherente con el DAG del punto 2.

Para comenzar con el análisis de los datos, quiero primero ver cuantos registros tengo de cada especie

```{r}
Count_sp_obs <- ddply(Data.CR.2020.BPI,~Scientific.Name,summarise,species_count=length(unique(Submission.ID)))

Count_sp_obs <- Count_sp_obs[order(Count_sp_obs$species_count),]
```

Por el momento no quiero usar todas las aves, escogí las que tienen más de 100 observaciones pero menos de 500. Parece un poco arbitrario  pero es que las especies que están presentes en gran cantidad en todos los sitios no nos van a brindar mucha información.

```{r}
Count_sp_obs.red <- Count_sp_obs[Count_sp_obs$species_count >=100 & Count_sp_obs$species_count <= 500,]

Count_sp_obs

```


Ahora podemos comenzar a hacer la matriz con la que vamos a trabajar. Primero necesito los datos correspondientes al año 2020
```{r}
Count_BPI_samp2020 <- ddply(Data.CR.2020.BPI[Data.CR.2020.BPI$year==2020,],~Location,summarise,Sampled_days=length(unique(Date)))

#Acá sólo quiero asegurarme de cuales fueron los meses muestreados este año
Months2020 <- sort(unique(Data.CR.2020.BPI$month[Data.CR.2020.BPI$year==2020]))
Months2020
```

Acá ya puedo crear la matiz para todos los datos de Costa Rica en el año 2020

```{r}
J= 4 #el número de réplicas
n= nrow(Datos_BPI_CR)
Sites <- Datos_BPI_CR[,1]
CR_2020_Matrix <- matrix(0, nrow=n, ncol=J,dimnames=list(1:n, paste("survey", 1:J, sep="")))
```

En este momento agrego la información de la biomasa sobre el suelo y del tipo de uso del suelo. (cuando con una resolución a 30m y otra a 100m)

```{r}
LandUseCR_30m <- read.csv("C:/Users/in/Documents/MAESTRIA/Cursos/Estrategias/Trabajo_Final/LandUseCR_30m.csv")
head(LandUseCR_30m)
LandUseCR_100m <- read.csv("C:/Users/in/Documents/MAESTRIA/Cursos/Estrategias/Trabajo_Final/LandUseCR_100m.csv")
head(LandUseCR_100m)
LandUseCR_100m_red <- LandUseCR_100m[,c(1,9)]
CRbuff30_aboveGbio <- read.csv("C:/Users/in/Documents/MAESTRIA/Cursos/Estrategias/Trabajo_Final/CRbuff30_aboveGbio.csv")
head(CRbuff30_aboveGbio)
names(CRbuff30_aboveGbio) <- c("ID","Biomass_30m","Location","Coordinates")
CRbuff100_aboveGbio <- read.csv("C:/Users/in/Documents/MAESTRIA/Cursos/Estrategias/Trabajo_Final/CRbuff100_aboveGbio.csv")
head(CRbuff100_aboveGbio)
names(CRbuff100_aboveGbio) <- c("ID","Biomass_100m","Location","Coordinates")


#acontinuación  lo unimos todo en un sólo archivo
CR_Hab1 <- CRbuff30_aboveGbio %>% left_join(CRbuff100_aboveGbio)
names(LandUseCR_100m_red) <- c("ID","Per_Forest")
CR_Hab_BPI <- CR_Hab1 %>% left_join(LandUseCR_100m_red)
CR_Hab_BPI2 <- as.data.frame(CR_Hab_BPI[,c(3,2,5,6)])

```

Seguidamente estandarizo las variables que voy a utilizar para ver como está distribuidas

```{r}
CR_HAB_BPI <- as.data.frame(scale(CR_Hab_BPI2[,-c(1)]))
hist(CR_HAB_BPI$Biomass_30m)
hist(CR_HAB_BPI$Biomass_100m)
hist(log(CR_HAB_BPI$Per_Forest))
```
El histograma de porcentaje de bosque no muestra una distribución normal.

Acá nada más me interesa poner el nombre de los sitios como un caractér 
```{r}
Sites_BPI_Obvs <- as.character(CR_Hab_BPI2[,1])
```


```{r}
i=1

Species_CR <- Count_sp_obs.red[-1,1]

    sp.name <- Species_CR[i] 
    temp.det.mat <- CR_2020_Matrix  #esta es la matriz de presencia ausencia para cada una de las réplicas
    temp.data <- Data.CR.2020.BPI %>%
    filter(Scientific.Name == sp.name) %>%
    filter(year == 2020) %>%
    filter(month %in% Months2020[1:3])
    temp.sites <- unique(temp.data$Location)
    site.match <- match(Sites_BPI_Obvs,temp.sites)
    site.idx <- !is.na(match(Sites_BPI_Obvs,temp.sites))
    for(ii in 1:length(Sites_BPI_Obvs)){
      if(site.idx[ii] == TRUE){
      temp.site <- temp.data %>%
        filter(Location == temp.sites[site.match[ii]])
        n.obs <- nrow(temp.site)
        if(n.obs > 4){
          n.obs <- 4;
        } #acá hice este ajuste porque hay sitios que tienen más de 4 réplicas en 2020 pero es porque son del 2019 que se terminaron tarde.
        for(n in 1:n.obs){
          temp.det.mat[ii,n] <- 1;
        }
      }else if(site.idx[ii] == FALSE){ 
      temp.det.mat <- temp.det.mat
      }
    }
```

Y ahora vamos a explorar utilizando a la reinita cafetalera como ejemplo :

```{r}
BasRufUMF <- unmarkedFrameOccu(y = temp.det.mat,siteCovs = CR_HAB_BPI)
summary(BasRufUMF)
str(BasRufUMF)
BasRufUMF[1:5,]    

```

Acontinuación el modelo nulo:
```{r}
(null <- occu(~1 ~1, BasRufUMF))

## Backtransform: transforma "de vuelta" psi y p a la escala original
# NOTA: esta función sólo funciona en el modelo nulo
backTransform(null, "state") #probabilidad de ocupación
backTransform(null, "det") #probabilidad de detección
```
Acá el modelo global: 
```{r}
# Modelo global (ie, con biomasa en ambas resoluciones)
full <- occu(~Biomass_100m +Biomass_30m ~Biomass_100m + Biomass_30m, BasRufUMF)

occ_dredge <- dredge(full)

#Comparación de modelos para explorar los resultados para ocupación: 
occ_dredge_table <- occ_dredge%>%
  mutate_all(~ round(., 3))

Occ_res <- as.data.frame(occ_dredge_table)

Occ_res
#Acá con la tabla de selección del modelo se puede observar cuales modelos tienen el mayor apoyo en el caso de esta especie here you can see which models have the most support for this species

```

Procedemos a la escogencia del mejor modelo utilizando el criterio de información de AKAIKE
```{r}
# Los modelos con menos de 2.5 Delta AICc)
occ_dredge_Delta <- get.models(occ_dredge, subset = delta <= 2.5)

# modelos promediados basados en el peso del modelo  
occ_avg <- model.avg(occ_dredge_Delta, fit = TRUE)

#  coeficientes de los modelos promediados para lsa probabilidades de ocupación y detección. fr the models with the most support from the data
coef(occ_avg)
```

#create a new data frame
```{r}
newDatHab <- data.frame(Biomass_100m = mean(CR_HAB_BPI$Biomass_100m),
                        Biomass_30m = seq(min(CR_HAB_BPI$Biomass_30m),max(CR_HAB_BPI$Biomass_30m), length=100),
                        Per_Forest = mean(CR_HAB_BPI$Per_Forest))


occ_pred <- predict(occ_avg,
                    newdata = newDatHab,
                    type = "state")

Biomass_30m <- seq(min(CR_Hab_BPI2$Biomass_30m),max(CR_Hab_BPI2$Biomass_30m), length=100)

# par(mfrow=c(2,3))
plot(Biomass_30m, occ_pred$fit, xlab="Above Ground Biomass at 30m",
       ylab="Occupancy Probability", pch=16, ylim=0:1, type="l",
       lwd=2, main = Species_CR[28])
lines(Biomass_30m, occ_pred$fit-occ_pred$se.fit, lty=3,col=3)
lines(Biomass_30m, occ_pred$fit+occ_pred$se.fit, lty=3,col=3)

```

#create a new data frame
```{r}
# newDatHab2 <- data.frame(Biomass_100m = seq(min(CR_HAB_BPI$Biomass_100m),max(CR_HAB_BPI$Biomass_100m), length=100),
#                         Biomass_30m = mean(CR_HAB_BPI$Biomass_30m),
#                         Per_Forest = mean(CR_HAB_BPI$Per_Forest))
# 
# 
# occ_pred2 <- predict(occ_avg,
#                     newdata = newDatHab2,
#                     type = "state")
# 
# Biomass_100m <- seq(min(CR_Hab_BPI2$Biomass_100m),max(CR_Hab_BPI2$Biomass_100m), length=100)
# plot(Biomass_100m, occ_pred2$fit, xlab="Above Ground Biomass at 100m",
#      ylab="Occupancy Probability", pch=16, ylim=0:1, type="l",
#      # lwd=2, main = Species_CR[i])
#      lwd=3, main = Species_Res_names[i],col=3)
# lines(Biomass_100m, occ_pred2$fit-occ_pred2$se.fit, lty=3,col=3)
# lines(Biomass_100m, occ_pred2$fit+occ_pred2$se.fit, lty=3,col=3)

```

# save(data1, data2, file = "data.RData")


5. Interpretación breve de los resultados con respecto a la  pregunta de investigación y la hipótesis causal. Máximo un párrafo.


